name: Update Leaderboard
on:
  pull_request:
    types: [closed]

# Ensure the job can push changes
permissions:
  contents: write

jobs:
  update:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0        # recommended when making commits
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run leaderboard update
        run: node scripts/updateLeaderboard.js

      - name: Commit and push changes (only if any)
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_USER: ${{ github.event.pull_request.user.login }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Stage only the files we expect the script to update
          git add DomainsLeaderboards/Overall.md HallOfFame/README.md || true

          # If there are no staged changes, exit gracefully
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update leaderboard and Hall of Fame after merged PR #${PR_NUMBER} by @${PR_USER}"
            git push
          fi
